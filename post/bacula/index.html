<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>
      
      Sistema de copias de seguridad - De Rookie a Leyenda
      
		</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" type="text/css" href="/hugo/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/hugo/assets/css/icons.css" />
    <link rel="stylesheet" type="text/css" href="/hugo/assets/css/screen.css" />
    
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel="stylesheet">
    

    
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/hugo/assets/bigfoot/dist/bigfoot.js"></script>
    <link rel="stylesheet" type="text/css" href="/hugo/assets/bigfoot/dist/bigfoot-number.css" />
    <script type="text/javascript">
        $.bigfoot();
    </script>
    
    
</head>

    <body class="post-template">
        <header class="main-header">
	<div class="main-header-content">
		<h1 class="blog-title">
			<a href="/hugo/">
				
           De Rookie a Leyenda
				
			</a>
		</h1>
		<h2 class="blog-description">Ernesto Vázquez García</h2>
	</div>

	<div class="nav">
    
		
	</div>
</header>

        
<main class="content" role="main">
  <article class="post">
    <header class="post-header">
      
      <h2 class="post-title">Sistema de copias de seguridad</h2>
      <section class="post-meta">
        <time class="post-date">January 22, 2020</time>
      </section>
    </header>
    <section class="post-content">
      

<p>Implementar un sistema de copias de seguridad para las instancias del cloud, teniendo en cuenta las siguientes características:</p>

<ul>
<li>Selecciona una aplicación para realizar el proceso: bacula, amanda, shell script con tar, rsync, dar, afio, etc.</li>
<li>Utiliza una de las instancias como servidor de copias de seguridad, añadiéndole un volumen y almacenando localmente las copias de seguridad que consideres adecuadas en él.</li>
<li>El proceso debe realizarse de forma completamente automática</li>
<li>Selecciona qué información es necesaria guardar (listado de paquetes, ficheros de configuración, documentos, datos, etc.)</li>
<li>Realiza semanalmente una copia completa</li>
<li>Realiza diariamente una copia incremental o diferencial (decidir cual es más adecuada)</li>
<li>Implementa una planificación del almacenamiento de copias de seguridad para una ejecución prevista de varios años, detallando qué copias completas se almacenarán de forma permanente y cuales se irán borrando</li>
<li>Añade tu sistema de copias a coconut cuando esté disponible</li>
<li>Selecciona un directorio de datos &ldquo;críticos&rdquo; que deberá almacenarse cifrado en la copia de seguridad, bien encargándote de hacer la copia manualmente o incluyendo la contraseña de cifrado en el sistema</li>
<li>Incluye en la copia los datos de las nuevas aplicaciones que se vayan instalando durante el resto del curso</li>
<li>Utiliza saturno u otra opción que se te facilite como equipo secundario para almacenar las copias de seguridad. Solicita acceso o la instalación de las aplicaciones que sean precisas.</li>
</ul>

<p>La corrección consistirá tanto en la restauración puntual de un fichero en cualquier fecha como la restauración completa de una de las instancias la última semana de curso.</p>

<hr />

<p>Instalación de <strong>mysql</strong>:</p>

<pre><code>debian@serranito:~$ sudo apt install mariadb-server mariadb-client
</code></pre>

<p>Instalación de <strong>bacula</strong>:</p>

<pre><code>debian@serranito:~$ sudo apt install bacula bacula-client bacula-common-mysql bacula-director-mysql bacula-server
</code></pre>

<p><img src="https://raw.githubusercontent.com/ernestovazquez/hugo/gh-pages/img/bacula1.png" alt="bacula1" /></p>

<p>Le damos a <strong>Yes</strong> y ponemos la contraseña.</p>

<p>Vamos al fichero de configuración:</p>

<pre><code>debian@serranito:~$ sudo cat /etc/bacula/bacula-dir.conf

Director {
  Name = directorserranito
  DIRport = 9101
  QueryFile = &quot;/etc/bacula/scripts/query.sql&quot;
  WorkingDirectory = &quot;/var/lib/bacula&quot;
  PidDirectory = &quot;/run/bacula&quot;
  Maximum Concurrent Jobs = 20
  Password = &quot;ernestovazquez11&quot;
  Messages = Daemon
  DirAddress = 10.0.0.11
}

JobDefs {
  Name = &quot;JobDaily&quot;
  Type = Backup
  Level = Incremental
  Client = serranito-fd
  Schedule = &quot;HorarioDiario&quot;
  Pool = Daily
  Storage = FileSerranito
  Messages = Standard
  SpoolAttributes = yes
  Priority = 10
  Write Bootstrap = &quot;/var/lib/bacula/%c.bsr&quot;
}


JobDefs {
  Name = &quot;JobWeekly&quot;
  Type = Backup
  Client = serranito-fd
  Schedule = &quot;HorarioSemanal&quot;
  Pool = Weekly
  Storage = FileSerranito
  Messages = Standard
  SpoolAttributes = yes
  Priority = 10
  Write Bootstrap = &quot;/var/lib/bacula/%c.bsr&quot;
}


JobDefs {
  Name = &quot;JobMonthly&quot;
  Type = Backup
  Client = serranito-fd
  Schedule = &quot;HorarioMensual&quot;
  Pool = Monthly
  Storage = FileSerranito
  Messages = Standard
  SpoolAttributes = yes
  Priority = 10
  Write Bootstrap = &quot;/var/lib/bacula/%c.bsr&quot;
}


Job {
 Name = &quot;BackupDiarioSerranito&quot;
 JobDefs = &quot;JobDaily&quot;
 Client = &quot;serranito-fd&quot;
 FileSet= &quot;CopiaSerranito&quot;
}


Job {
 Name = &quot;BackupDiarioCroqueta&quot;
 JobDefs = &quot;JobDaily&quot;
 Client = &quot;croqueta-fd&quot;
 FileSet= &quot;CopiaCroqueta&quot;
}


Job {
 Name = &quot;BackupDiarioTortilla&quot;
 JobDefs = &quot;JobDaily&quot;
 Client = &quot;tortilla-fd&quot;
 FileSet= &quot;CopiaTortilla&quot;
}


Job {
 Name = &quot;BackupDiarioSalmorejo&quot;
 JobDefs = &quot;JobDaily&quot;
 Client = &quot;salmorejo-fd&quot;
 FileSet= &quot;CopiaSalmorejo&quot;
}


Job {
 Name = &quot;BackupSemanalSerranito&quot;
 JobDefs = &quot;JobWeekly&quot;
 Client = &quot;serranito-fd&quot;
 FileSet= &quot;CopiaSerranito&quot;
}


Job {
 Name = &quot;BackupSemanalCroqueta&quot;
 JobDefs = &quot;JobWeekly&quot;
 Client = &quot;croqueta-fd&quot;
 FileSet= &quot;CopiaCroqueta&quot;
}

Job {
 Name = &quot;BackupSemanalTortilla&quot;
 JobDefs = &quot;JobWeekly&quot;
 Client = &quot;tortilla-fd&quot;
 FileSet= &quot;CopiaTortilla&quot;
}

Job {
 Name = &quot;BackupSemanalSalmorejo&quot;
 JobDefs = &quot;JobWeekly&quot;
 Client = &quot;salmorejo-fd&quot;
 FileSet= &quot;CopiaSalmorejo&quot;
}


Job {
 Name = &quot;BackupMensualSerranito&quot;
 JobDefs = &quot;JobMonthly&quot;
 Client = &quot;serranito-fd&quot;
 FileSet= &quot;CopiaSerranito&quot;
}


Job {
 Name = &quot;BackupMensualCroqueta&quot;
 JobDefs = &quot;JobMonthly&quot;
 Client = &quot;croqueta-fd&quot;
 FileSet= &quot;CopiaCroqueta&quot;
}


Job {
 Name = &quot;BackupMensualTortilla&quot;
 JobDefs = &quot;JobMonthly&quot;
 Client = &quot;tortilla-fd&quot;
 FileSet= &quot;CopiaTortilla&quot;
}


Job {
 Name = &quot;BackupMensualSalmorejo&quot;
 JobDefs = &quot;JobMonthly&quot;
 Client = &quot;salmorejo-fd&quot;
 FileSet= &quot;CopiaSalmorejo&quot;
}


Job {
 Name = &quot;Serranitorestaurar&quot;
 Type = Restore
 Client=serranito-fd
 FileSet= &quot;CopiaSerranito&quot;
 Storage = FileSerranito
 Pool = Vol-Backup
 Messages = Standard
}

Job {
 Name = &quot;Croquetarestaurar&quot;
 Type = Restore
 Client=croqueta-fd
 FileSet= &quot;CopiaCroqueta&quot;
 Storage = FileSerranito
 Pool = Vol-Backup
 Messages = Standard
}

Job {
 Name = &quot;Tortillarestaurar&quot;
 Type = Restore
 Client=tortilla-fd
 FileSet= &quot;CopiaTortilla&quot;
 Storage = FileSerranito
 Pool = Vol-Backup
 Messages = Standard
}

Job {
 Name = &quot;Salmorejorestaurar&quot;
 Type = Restore
 Client=salmorejo-fd
 FileSet= &quot;CopiaSalmorejo&quot;
 Storage = FileSerranito
 Pool = Vol-Backup
 Messages = Standard
}


FileSet {
 Name = &quot;CopiaSerranito&quot;
 Include {
    Options {
        signature = MD5
        compression = GZIP
    }
    File = /home
    File = /etc
    File = /var
    File = /bacula
 }
 Exclude {
    File = /nonexistant/path/to/file/archive/dir
    File = /proc
    File = /var/cache
    File = /var/tmp
    File = /tmp
    File = /sys
    File = /.journal
    File = /.fsck
 }
}

FileSet {
 Name = &quot;CopiaCroqueta&quot;
 Include {
    Options {
        signature = MD5
        compression = GZIP
    }
    File = /home
    File = /etc
    File = /var
 }
 Exclude {
    File = /var/lib/bacula
    File = /nonexistant/path/to/file/archive/dir
    File = /proc
    File = /var/tmp
    File = /tmp
    File = /sys
    File = /.journal
    File = /.fsck
 }
}

FileSet {
 Name = &quot;CopiaTortilla&quot;
 Include {
    Options {
        signature = MD5
        compression = GZIP
    }
    File = /home
    File = /etc
    File = /var
 }
 Exclude {
    File = /var/lib/bacula
    File = /nonexistant/path/to/file/archive/dir
    File = /proc
    File = /var/cache
    File = /var/tmp
    File = /tmp
    File = /sys
    File = /.journal
    File = /.fsck
 }
}

FileSet {
 Name = &quot;CopiaSalmorejo&quot;
 Include {
    Options {
        signature = MD5
        compression = GZIP
    }
    File = /home
    File = /etc
    File = /var
    File = /usr/share/nginx
 }
 Exclude {
    File = /var/lib/bacula
    File = /nonexistant/path/to/file/archive/dir
    File = /proc
    File = /var/cache
    File = /var/tmp
    File = /tmp
    File = /sys
    File = /.journal
    File = /.fsck
 }
}


Schedule {
 Name = &quot;HorarioDiario&quot;
 Run = Level=Incremental Pool=Daily daily at 21:30
}

Schedule {
 Name = &quot;HorarioSemanal&quot;
 Run = Level=Full Pool=Weekly sat at 20:00
}

Schedule {
 Name = &quot;HorarioMensual&quot;
 Run = Level=Full Pool=Monthly 1st sun at 22:00 
}


Client {
 Name = serranito-fd
 Address = 10.0.0.11
 FDPort = 9102
 Catalog = mysql-bacula
 Password = &quot;ernestovazquez11&quot;
 File Retention = 90 days
 Job Retention = 6 months
 AutoPrune = yes
}


Client {
 Name = croqueta-fd
 Address = 10.0.0.10
 FDPort = 9102
 Catalog = mysql-bacula
 Password = &quot;ernestovazquez11&quot;
 File Retention = 90 days
 Job Retention = 6 months
 AutoPrune = yes
}


Client {
 Name = tortilla-fd
 Address = 10.0.0.4
 FDPort = 9102
 Catalog = mysql-bacula
 Password = &quot;ernestovazquez11&quot;
 File Retention = 90 days
 Job Retention = 6 months
 AutoPrune = yes
}


Client {
 Name = salmorejo-fd
 Address = 10.0.0.13
 FDPort = 9102
 Catalog = mysql-bacula
 Password = &quot;ernestovazquez11&quot;
 File Retention = 90 days
 Job Retention = 6 months
 AutoPrune = yes
}


Storage {
 Name = FileSerranito
 Address = 10.0.0.11
 SDPort = 9103
 Password = &quot;ernestovazquez11&quot;
 Device = FileAutochanger1
 Media Type = File
 Maximum Concurrent Jobs = 10
}


Catalog {
 Name = mysql-bacula
 dbname = &quot;bacula&quot;; DB Address = &quot;localhost&quot;; dbuser = &quot;bacula&quot;; dbpassword = &quot;ernestovazquez11&quot;
}


Pool {
 Name = Daily
 Use Volume Once = yes
 Pool Type = Backup
 AutoPrune = yes
 VolumeRetention = 10d
 Recycle = yes
}


Pool {
 Name = Weekly
 Use Volume Once = yes
 Pool Type = Backup
 AutoPrune = yes
 VolumeRetention = 30d
 Recycle = yes
}


Pool {
 Name = Monthly
 Use Volume Once = yes
 Pool Type = Backup
 AutoPrune = yes
 VolumeRetention = 365d
 Recycle = yes
}

Pool {
 Name = Vol-Backup
 Pool Type = Backup
 Recycle = yes 
 AutoPrune = yes
 Volume Retention = 365 days 
 Maximum Volume Bytes = 50G
 Maximum Volumes = 100
 Label Format = &quot;Volumenlabel&quot;
}


# Reasonable message delivery -- send most everything to email address
#  and to the console
Messages {
  Name = Standard
#
# NOTE! If you send to two email or more email addresses, you will need
#  to replace the %r in the from field (-f part) with a single valid
#  email address in both the mailcommand and the operatorcommand.
#  What this does is, it sets the email address that emails would display
#  in the FROM field, which is by default the same email as they're being
#  sent to.  However, if you send email to more than one address, then
#  you'll have to set the FROM address manually, to a single address.
#  for example, a 'no-reply@mydomain.com', is better since that tends to
#  tell (most) people that its coming from an automated source.

#
  mailcommand = &quot;/usr/sbin/bsmtp -h localhost -f \&quot;\(Bacula\) \&lt;%r\&gt;\&quot; -s \&quot;Bacula: %t %e of %c %l\&quot; %r&quot;
  operatorcommand = &quot;/usr/sbin/bsmtp -h localhost -f \&quot;\(Bacula\) \&lt;%r\&gt;\&quot; -s \&quot;Bacula: Intervention needed for %j\&quot; %r&quot;
  mail = root = all, !skipped
  operator = root = mount
  console = all, !skipped, !saved
#
# WARNING! the following will create a file that you must cycle from
#          time to time as it will grow indefinitely. However, it will
#          also keep all your messages if they scroll off the console.
#
  append = &quot;/var/log/bacula/bacula.log&quot; = all, !skipped
  catalog = all
}


#
# Message delivery for daemon messages (no job).
Messages {
  Name = Daemon
  mailcommand = &quot;/usr/sbin/bsmtp -h localhost -f \&quot;\(Bacula\) \&lt;%r\&gt;\&quot; -s \&quot;Bacula daemon message\&quot; %r&quot;
  mail = root = all, !skipped
  console = all, !skipped, !saved
  append = &quot;/var/log/bacula/bacula.log&quot; = all, !skipped
}

# Default pool definition
Pool {
  Name = Default
  Pool Type = Backup
  Recycle = yes                       # Bacula can automatically recycle Volumes
  AutoPrune = yes                     # Prune expired volumes
  Volume Retention = 365 days         # one year
  Maximum Volume Bytes = 50G          # Limit Volume size to something reasonable
  Maximum Volumes = 100               # Limit number of Volumes in Pool
}

# Scratch pool definition
Pool {
  Name = Scratch
  Pool Type = Backup
}

#
# Restricted console used by tray-monitor to get the status of the director
#
Console {
  Name = serranito-mon
  Password = &quot;fIw4a5kGo9eA-lUCL9vyFEpbrANkwG1K4&quot;
  CommandACL = status, .status
}
</code></pre>

<p>Asignamos el <strong>volumen</strong> nuevo en OpenStack.</p>

<pre><code>debian@serranito:~$ lsblk -f
NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         6197e068-a892-45cb-9672-a05813e800ee    7.3G    22% /
vdb                                                                     
</code></pre>

<pre><code>debian@serranito:~$ sudo fdisk /dev/vdb

Welcome to fdisk (util-linux 2.33.1).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0xe688ea79.

Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (1-4, default 1): 1
First sector (2048-10485759, default 2048): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-10485759, default 10485759): 

Created a new partition 1 of type 'Linux' and of size 5 GiB.

Command (m for help): p
Disk /dev/vdb: 5 GiB, 5368709120 bytes, 10485760 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xe688ea79

Device     Boot Start      End  Sectors Size Id Type
/dev/vdb1        2048 10485759 10483712   5G 83 Linux

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Syncing disks.
</code></pre>

<p>Formateamos la partición</p>

<pre><code>debian@serranito:~$ sudo mkfs.ext4 /dev/vdb1 

mke2fs 1.44.5 (15-Dec-2018)
Creating filesystem with 1310464 4k blocks and 327680 inodes
Filesystem UUID: 92d0b792-c34f-4866-a8fd-48380d4513ad
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done 
</code></pre>

<pre><code>debian@serranito:~$ lsblk -f

NAME   FSTYPE LABEL UUID                                 FSAVAIL FSUSE% MOUNTPOINT
vda                                                                     
└─vda1 ext4         6197e068-a892-45cb-9672-a05813e800ee    7.3G    22% /
vdb                                                                     
└─vdb1 ext4         92d0b792-c34f-4866-a8fd-48380d4513ad    
</code></pre>

<p>Vamos a montarlo, para ello vamos a crear una carpeta donde estarán las copias de seguridad.</p>

<pre><code>debian@serranito:~$ sudo mkdir -p /bacula/Copias
</code></pre>

<p>Editamos el fichero de configuración y agregamos lo siguiente:</p>

<pre><code>debian@serranito:~$ sudo nano /etc/fstab 

UUID=92d0b792-c34f-4866-a8fd-48380d4513ad       /bacula/Copias  ext4    defaults        0       0
</code></pre>

<p>Dicho UUID se obtiene de esta manera:</p>

<pre><code>debian@serranito:~$ lsblk -f | egrep &quot;vdb1 *&quot; | cut -d&quot; &quot; -f11
92d0b792-c34f-4866-a8fd-48380d4513ad
</code></pre>

<h3 id="configuración-bacula-sd-conf">Configuración bacula-sd.conf</h3>

<p>Editamos el siguiente fichero de configuración:</p>

<pre><code>debian@serranito:~$ sudo nano /etc/bacula/bacula-sd.conf 

Storage { 
 Name = serranito-sd
 SDPort = 9103 
 WorkingDirectory = &quot;/var/lib/bacula&quot;
 Pid Directory = &quot;/run/bacula&quot;
 Maximum Concurrent Jobs = 20
 SDAddress = 10.0.0.11
}


Director {
 Name = directorserranito
 Password = &quot;ernestovazquez11&quot;
}


Director {
 Name = serranito-mon
 Password = &quot;bacula&quot;
 Monitor = yes
}


Autochanger {
 Name = FileAutochanger1
 Device = DispositivoCopia
 Changer Command = &quot;&quot;
 Changer Device = /dev/null
}


Device {
 Name = DispositivoCopia
 Media Type = File
 Archive Device = /bacula/Copias_de_Seguridad
 LabelMedia = yes;
 Random Access = Yes;
 AutomaticMount = yes;
 RemovableMedia = no;
 AlwaysOpen = no;
 Maximum Concurrent Jobs = 5
}


Messages {
  Name = Standard
  director = directorserranito = all
}
</code></pre>

<p>Reiniciamos los servicios</p>

<pre><code>debian@serranito:~$ sudo systemctl restart bacula-director.service
debian@serranito:~$ sudo systemctl restart bacula-sd.service
</code></pre>

<p>Modificamos el fichero <strong>bconsole.conf</strong>:</p>

<pre><code>debian@serranito:~$ sudo nano /etc/bacula/bconsole.conf 

Director {
  Name = directorserranito
  DIRport = 9101
  address = 10.0.0.11
  Password = &quot;ernestovazquez11&quot; 
}
</code></pre>

<h3 id="clientes">Clientes</h3>

<p>Vamos a instalar los clientes en los diferentes servidores del cloud.</p>

<pre><code>debian@serranito:~$ sudo apt install bacula-client
debian@croqueta:~$ sudo apt install bacula-client
ubuntu@tortilla:~$ sudo apt install bacula-client
[centos@salmorejo ~]$ sudo dnf install bacula-client
</code></pre>

    </section>
    <footer class="post-footer">
      
    </footer>
  </article>
</main>

        <footer class="site-footer">
  <section class="rss"><a class="subscribe-button icon-feed" href="/index.xml"></a></section>
  <section class="twitter"><a class="icon-twitter" href="https://twitter.com/ernestovazgar"> ernestovazgar</a></section>
  
  <section class="copyright">&copy; 2020 De Rookie a Leyenda</section>
  <section class="poweredby"><a href="https://github.com/nirocfz/arabica">Arabica</a> theme by Sean Lunsford. Published with <a href="https://gohugo.io">Hugo</a>.</section>
</footer>



    </body>
</html>
