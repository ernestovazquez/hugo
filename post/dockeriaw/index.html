<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>
      
      Implantación de aplicaciones web PHP en docker - De Rookie a Leyenda
      
		</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/icons.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel="stylesheet">
    

    
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/bigfoot/dist/bigfoot.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/bigfoot/dist/bigfoot-number.css" />
    <script type="text/javascript">
        $.bigfoot();
    </script>
    
    
</head>

    <body class="post-template">
        <header class="main-header">
	<div class="main-header-content">
		<h1 class="blog-title">
			<a href="/">
				
           De Rookie a Leyenda
				
			</a>
		</h1>
		<h2 class="blog-description">Ernesto Vázquez García</h2>
	</div>

	<div class="nav">
    
		
	</div>
</header>

        
<main class="content" role="main">
  <article class="post">
    <header class="post-header">
      
      <h2 class="post-title">Implantación de aplicaciones web PHP en docker</h2>
      <section class="post-meta">
        <time class="post-date">February 18, 2020</time>
      </section>
    </header>
    <section class="post-content">
      

<p>Queremos ejecutar en un contenedor docker la aplicación web escrita en PHP: <a href="https://github.com/evilnapsis/bookmedik">bookMedik</a>.</p>

<hr />

<h2 id="tarea-1">Tarea 1</h2>

<p><strong>Ejecución de la aplicación web PHP bookMedik en docker</strong></p>

<ul>
<li>Queremos ejecutar en un contenedor docker la aplicación web escrita en PHP: bookMedik (<a href="https://github.com/evilnapsis/bookmedik">https://github.com/evilnapsis/bookmedik</a>).</li>
<li>Es necesario tener un contenedor con mariadb donde vamos a crear la base de datos y los datos de la aplicación. El script para generar la base de datos y los registros lo encuentras en el repositorio y se llama schema.sql. Debes crear un usuario con su contraseña en la base de datos. La base de datos se llama bookmedik y se crea al ejecutar el script.</li>
<li>Ejecuta el contenedor mariadb y carga los datos del script schema.sql. Para más información.</li>
<li>El contenedor mariadb debe tener un volumen para guardar la base de datos.</li>
<li>Crea una imagen docker con la aplicación desde una imagen base de debian o ubuntu. Ten en cuenta que el fichero de configuración de la base de datos (core\controller\Database.php) lo tienes que configurar utilizando las variables de entorno del contenedor mariadb. (Nota: Para obtener las variables de entorno en PHP usar la función getenv. Para más infomación).</li>
<li>La imagen la tienes que crear en tu máquina con el comando docker build.</li>
<li>Crea un contenedor a partir de la imagen anterior, enlazado con el contenedor mariadb, y comprueba que está funcionando (Usuario: admin, contraseña: admin)</li>
<li>El contenedor que creas debe tener un volumen para guardar los logs de apache2.</li>
</ul>

<hr />

<p>Creamos la red del contenedor:</p>

<pre><code>root@bookmedik:~/tarea1# docker network create bookmedik
156229b4609abda50303cc7cd7e355bbdf317087f4c511e1a6ca93addd592b89
</code></pre>

<p>Contenedor de la base de datos:</p>

<pre><code>root@bookmedik:~/tarea1# docker run -d --name servidor_mysql --network bookmedik -e MYSQL_DATABASE=bookmedik -e MYSQL_USER=bookmedik -e MYSQL_PASSWORD=bookmedik -e MYSQL_ROOT_PASSWORD=asdasd mariadb
</code></pre>

<p>Cargamos los datos en la base de datos</p>

<pre><code>root@bookmedik:~/tarea1/bookmedik# cat schema.sql | docker exec -i servidor_mysql /usr/bin/mysql -u root --password=asdasd bookmedik
</code></pre>

<pre><code>root@bookmedik:~/tarea1# nano Dockerfile 

FROM debian
RUN apt-get update &amp;&amp; apt-get install -y apache2 libapache2-mod-php7.3 php7.3 php7.3-mysql &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*
RUN rm /var/www/html/index.html
ENV APACHE_SERVER_NAME www.bookmedikernesto.com
ENV MARIADB_USER bookmedik
ENV MARIADB_PASS bookmedik
ENV MARIADB_HOST servidor_mysql

EXPOSE 80

COPY ./bookmedik /var/www/html
ADD script.sh /usr/local/bin/script.sh

RUN chmod +x /usr/local/bin/script.sh

CMD [&quot;/usr/local/bin/script.sh&quot;]
</code></pre>

<p>Script:</p>

<pre><code>root@docker:~# cat script.sh 
#!/bin/bash
sed -i 's/$this-&gt;user=&quot;root&quot;;/$this-&gt;user=&quot;'${MARIADB_USER}'&quot;;/g' /var/www/html/core/controller/Database.php
sed -i 's/$this-&gt;pass=&quot;&quot;;/$this-&gt;pass=&quot;'${MARIADB_PASS}'&quot;;/g' /var/www/html/core/controller/Database.php
sed -i 's/$this-&gt;host=&quot;localhost&quot;;/$this-&gt;host=&quot;'${MARIADB_HOST}'&quot;;/g' /var/www/html/core/controller/Database.php
apache2ctl -D FOREGROUND
</code></pre>

<p>Imagen y contenedor:</p>

<pre><code>root@docker:~# docker build -t ernestovazquez/bookmedik:v1 .

root@bookmedik:~/tarea1# docker run -d --name bookmedik --network bookmedik -p 80:80 ernestovazquez/bookmedik:v1
</code></pre>

<p><img src="https://i.imgur.com/KAsftEG.png" alt="" /></p>

<p>Volumen de la base de datos:</p>

<pre><code>root@docker:~# docker run -d --name servidor_mysql --network bookmedik -v /opt/bbdd_mariadb:/var/lib/mysql -e MYSQL_DATABASE=bookmedik -e MYSQL_USER=bookmedik -e MYSQL_PASSWORD=bookmedik -e MYSQL_ROOT_PASSWORD=bookmedik mariadb
</code></pre>

<p>Log para apache</p>

<pre><code>root@docker:~# docker run -d --name bookmedik --network bookmedik -v /opt/logs_apache2:/var/log/apache2 -p 80:80 ernestovazquez/bookmedik:v1

root@docker:~/bookmedik# cat schema.sql | docker exec -i servidor_mysql /usr/bin/mysql -u root --password=asdasd bookmedik
</code></pre>

<p>Vemos de nuevo la web:</p>

<p><img src="https://i.imgur.com/8uQH0Ae.png" alt="" /></p>

<pre><code>root@docker:~# docker ps
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                NAMES
e82d5e331fab        ernestovazquez/bookmedik:v1   &quot;/usr/local/bin/scri…&quot;   2 minutes ago       Up 2 minutes        0.0.0.0:80-&gt;80/tcp   bookmedik
f25dbff87579        mariadb                       &quot;docker-entrypoint.s…&quot;   3 minutes ago       Up 3 minutes        3306/tcp             servidor_mysql

root@docker:~# docker rm -f f25dbff87579
f25dbff87579
root@docker:~# docker rm -f e82d5e331fab
e82d5e331fab

root@docker:~# docker run -d --name servidor_mysql --network bookmedik -v /opt/bbdd_mariadb:/var/lib/mysql -e MYSQL_DATABASE=bookmedik -e MYSQL_USER=bookmedik -e MYSQL_PASSWORD=bookmedik -e MYSQL_ROOT_PASSWORD=asdasd mariadb
a59e9e77e97f3881bfec19853d0cad9ca7a738f42e2ee329310bc60fee4b659f

root@docker:~# docker run -d --name bookmedik --network bookmedik -v /opt/logs_apache2:/var/log/apache2 -p 80:80 ernestovazquez/bookmedik:v1
ae3d89739b7ad7ed843caa7ec4657f4699d2cd85e86f0b29625129209af2e4d6
</code></pre>

<p><img src="https://i.imgur.com/t47Jnjj.png" alt="" /></p>

<h2 id="tarea-2">Tarea 2</h2>

<p><strong>Ejecución de una aplicación web PHP con imagenes de PHP y apache2 de DockerHub</strong></p>

<ul>
<li>Realiza la imagen docker de la aplicación a partir de la imagen oficial PHP que encuentras en docker hub. Lee la documentación de la imagen para configurar una imagen con apache2 y php, además seguramente tengas que instalar alguna extensión de php.</li>
<li>Crea esta imagen en docker hub.</li>
<li>Crea un script con docker compose que levante el escenario con los dos contenedores.</li>
</ul>

<hr />

<p>Ahora vamos a crear un script con docker compose que levante el escenario con los dos contenedores.</p>

<pre><code>version: '3.1'

services:
  bookmedikt2:
    container_name: bookmedikt2
    image: php:7.4.3-apache
    restart: always
    environment:
      MARIADB_USER: bookmedik
      MARIADB_PASS: bookmedik
      MARIADB_HOST: mysqlt2
    ports:
      - 80:80
    volumes:
      - /opt/logs_apache2:/var/log/apache2
      - ./script.sh:/usr/local/bin/script.sh
      - ./bookmedik:/var/www/html
    command: &gt;
      bash /usr/local/bin/script.sh
  mysqlt2:
    container_name: mysqlt2
    image: mariadb
    restart: always
    environment:
      MYSQL_DATABASE: bookmedik
      MYSQL_USER: bookmedik
      MYSQL_PASSWORD: bookmedik
      MYSQL_ROOT_PASSWORD: asdasd
    volumes:
      - /opt/mariat2:/var/lib/mysql
</code></pre>

<p>Dockerfile:</p>

<pre><code>FROM php:7.4.3-apache
ENV MARIADB_USER bookmedik
ENV MARIADB_PASS bookmedik
ENV MARIADB_HOST mysqlt2
RUN docker-php-ext-install pdo pdo_mysql mysqli json
RUN a2enmod rewrite
EXPOSE 80
WORKDIR /var/www/html
COPY ./bookmedik /var/www/html
ADD script.sh /usr/local/bin/script.sh
RUN chmod +x /usr/local/bin/script.sh
CMD [&quot;/usr/local/bin/script.sh&quot;]
</code></pre>

<p>Añadimos la siguiente linea al script que hemos creado anteriormente:</p>

<pre><code>docker-php-ext-install pdo pdo_mysql mysqli json
</code></pre>

<p>Levantamos docker-compose:</p>

<pre><code>root@docker:~/tarea2# docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES

root@docker:~/tarea2# docker-compose up -d
Creating bookmedikt2 ... done
Creating mysqlt2     ... done

root@docker:~/tarea2# docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                NAMES
03c7ae76bdd2        mariadb             &quot;docker-entrypoint.s…&quot;   39 seconds ago      Up 38 seconds       3306/tcp             mysqlt2
d6d8997f2cfc        php:7.4.3-apache    &quot;docker-php-entrypoi…&quot;   39 seconds ago      Up 38 seconds       0.0.0.0:80-&gt;80/tcp   bookmedikt2
</code></pre>

<p><img src="https://i.imgur.com/vAlZ0cQ.png" alt="" /></p>

<p><a href="https://github.com/ernestovazquez/docker-tarea2">https://github.com/ernestovazquez/docker-tarea2</a></p>

<h2 id="tarea-3">Tarea 3</h2>

<p><strong>Ejecución de un CMS en docker</strong></p>

<ul>
<li>En este caso queremos usar un contenedor que utilice nginx para servir la aplicación PHP. Puedes crear la imagen desde una imagen base debian o ubuntu o desde la imagen oficial de nginx.</li>
<li>Vamos a crear otro contenedor que sirva php-fpm.</li>
<li>Y finalmente nuestro contenedor con la aplicación.</li>
<li>Crea un script con docker compose que levante el escenario con los tres contenedores.</li>
</ul>

<p>A lo mejor te puede ayudar el siguiente enlace: Dockerise your PHP application with Nginx and PHP7-FPM</p>

<hr />

<p>Creamos el docker-compose:</p>

<pre><code>version: '3.1'

services:
  db:
    container_name: nginxdb           
    image: mariadb
    restart: always
    environment:
      MYSQL_USER: bookmedik
      MYSQL_PASSWORD: bookmedik
      MYSQL_DATABASE: bookmedik
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - /opt/mariat3:/var/lib/mysql
</code></pre>

<p>Levantamos el contenedor:</p>

<pre><code>root@docker:~/tarea3# docker-compose up -d
Creating network &quot;tarea3_default&quot; with the default driver
Creating nginxdb ... done
</code></pre>

<p>Comprobaciones:</p>

<pre><code>root@docker:~/tarea3/bookmedik# cat schema.sql | docker exec -i nginxdb /usr/bin/mysql -u root --password=root
root@docker:~/tarea3/bookmedik# docker exec -it nginxdb bash
MariaDB [bookmedik]&gt; show tables;
+---------------------+
| Tables_in_bookmedik |
+---------------------+
| category            |
| medic               |
| pacient             |
| payment             |
| reservation         |
| status              |
| user                |
+---------------------+
7 rows in set (0.001 sec)
</code></pre>

<p>Creación del Dockerfile:</p>

<pre><code>root@docker:~/tarea3# nano Dockerfile

FROM php:7-fpm
RUN docker-php-ext-install mysqli
ENV MYSQL_USER bookmedik
ENV MYSQL_PASSWORD bookmedik
ENV MYSQL_HOST nginxdb           
ENV MYSQL_DB bookmedik
EXPOSE 9000
</code></pre>

<p>Creamos la imagen.</p>

<p><code>root@docker:~/tarea3# docker build -t ernestovazquez/tarea3:v1 .</code></p>

<p>Editamos el docker-compose:</p>

<pre><code>root@docker:~/tarea3# nano docker-compose.yml 

  fpm:
    container_name: nginxfpm
    image: ernestovazquez/tarea3:v1
    volumes:
      - /opt/mariat3:/var/www/html
  app:
    container_name: bookmedik
    image: nginx:latest
    ports:
      - 80:80
    volumes:
      - /opt/mariat3:/var/www/html
      - ./bookmedik.conf:/etc/nginx/conf.d/default.conf
</code></pre>

<p>Por último levantamos los nuevos contenedores:</p>

<pre><code>root@docker:~/tarea3# docker-compose up -d
</code></pre>

<h2 id="tarea-4">Tarea 4</h2>

<ul>
<li>A partir de una imagen base (que no sea una imagen con el CMS), genera una imagen que despliegue un CMS PHP (que no sea wordpress). El contenedor que se crea a partir de esta imagen se tendrá que enlazar con un contenedor mariadb o postgreSQL.</li>
<li>Crea los volúmenes necesarios para que la información que se guarda sea persistente.</li>
</ul>

<hr />

<h2 id="tarea-5">Tarea 5</h2>

<p><strong>Ejecución de un CMS en docker con una imagen de DockerHub</strong></p>

<ul>
<li>Busca una imagen oficial de un CMS PHP en docker hub (distinto al que has instalado en la tarea anterior, ni wordpress), y crea los contenedores necesarios para servir el CMS, siguiendo la documentación de docker hub.</li>
</ul>

<hr />

<p>Creamos el docker-compose:</p>

<pre><code>version: '3'
services:
  mediawiki:
    image: mediawiki
    restart: always
    ports:
      - 8080:80
    links:
      - database
    volumes:
      - /var/www/html/images
      - ./LocalSettings.php:/var/www/html/LocalSettings.php
  database:
    image: mariadb
    restart: always
    environment:
      MYSQL_DATABASE: my_wiki
      MYSQL_USER: wikiuser
      MYSQL_PASSWORD: example
      MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
</code></pre>

<p>Lanzamos los contenedores con:</p>

<pre><code>root@docker:~/mediawiki# docker-compose up -d
Creating mediawiki_database_1 ... done
Creating mediawiki_mediawiki_1 ... done
</code></pre>

<p><img src="https://i.imgur.com/npeIROT.png" alt="" /></p>

<p><img src="https://i.imgur.com/reyDRZN.png" alt="" /></p>

<p><img src="https://i.imgur.com/Vshzxp9.png" alt="" /></p>

<p><img src="https://i.imgur.com/SOoIh4W.png" alt="" /></p>

<p>Nos descargamos el fichero y lo ponemos en el mismo directorio que el docker-compose.</p>

<pre><code>root@docker:~/mediawiki# ls
docker-compose.yml  LocalSettings.php
</code></pre>

<p>Cargamos de nuevo el docker-compose:</p>

<pre><code>mediawiki_database_1 is up-to-date
Recreating mediawiki_mediawiki_1 ... done

root@docker:~/mediawiki# ls
docker-compose.yml  LocalSettings.php
</code></pre>

<p><img src="https://i.imgur.com/OD7GAPW.png" alt="" /></p>

<p>Ya tendremos nuestra página cargada e instalada.</p>

    </section>
    <footer class="post-footer">
      
    </footer>
  </article>
</main>

        <footer class="site-footer">
  <section class="rss"><a class="subscribe-button icon-feed" href="/index.xml"></a></section>
  <section class="twitter"><a class="icon-twitter" href="https://twitter.com/ernestovazgar"> ernestovazgar</a></section>
  
  <section class="copyright">&copy; 2020 De Rookie a Leyenda</section>
  <section class="poweredby"><a href="https://github.com/nirocfz/arabica">Arabica</a> theme by Sean Lunsford. Published with <a href="https://gohugo.io">Hugo</a>.</section>
</footer>



    </body>
</html>
