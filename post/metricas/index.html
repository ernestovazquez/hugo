<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>
      
      Métricas, logs y monitorización - De Rookie a Leyenda
      
		</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/icons.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel="stylesheet">
    

    
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/bigfoot/dist/bigfoot.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/bigfoot/dist/bigfoot-number.css" />
    <script type="text/javascript">
        $.bigfoot();
    </script>
    
    
</head>

    <body class="post-template">
        <header class="main-header">
	<div class="main-header-content">
		<h1 class="blog-title">
			<a href="/">
				
           De Rookie a Leyenda
				
			</a>
		</h1>
		<h2 class="blog-description">Ernesto Vázquez García</h2>
	</div>

	<div class="nav">
    
		
	</div>
</header>

        
<main class="content" role="main">
  <article class="post">
    <header class="post-header">
      
      <h2 class="post-title">Métricas, logs y monitorización</h2>
      <section class="post-meta">
        <time class="post-date">January 28, 2020</time>
      </section>
    </header>
    <section class="post-content">
      

<p>Crea una nueva instancia de nombre serranito o reutiliza la que ya se estaba utilizando para copias de seguridad y realiza las partes que elijas entre las siguientes sobre de croqueta, salmorejo, tortilla y serranito (se puede hacer una, dos o las tres partes y el peso de la tarea se modificará consecuentemente):</p>

<ul>
<li>Métricas: recolección, gestión centralizada, filtrado y representación gráfica de los parámetros que consideres necesarios</li>
<li>Monitorización: Configuración de alertas por uso excesivo de recursos (memoria, disco raíz, etc.) y disponibilidad de los servicios. Alertas por correo, telegram, etc.</li>
<li>Gestión de logs: Implementa un sistema centralizado de filtrado que permita quedarse con registros con prioridad error, critical, alert o emergency. Representa gráficamente los datos relevantes extraidos de los logs o configura el envío por correo al administrador de los logs relevantes (una opción o ambas)</li>
</ul>

<p>Detalla en la documentación claramente las características de la implementación elegida, así como la forma de comprobar las características exigidas.</p>

<hr />

<p>En la nueva máquina llamada <strong>Serranito</strong> vamos a montar el sistema de monitorización. Con las siguientes combinaciones:</p>

<ul>
<li><p><strong>Telegraf</strong>: Se encarga de recolectar todos los datos que le pasamos mediante el fichero de configuración.</p></li>

<li><p><strong>InfluxDB</strong>: Es donde Telegraf manda toda esta información.</p></li>

<li><p><strong>Grafana</strong>: Es el Dashboard que se encarga de mostrar toda la información que InfluxDB tiene almacenado en las Bases de Datos.</p></li>
</ul>

<h2 id="instalación-de-influxdb">Instalación de InfluxDB</h2>

<p>Vamos a empezar con la instalación de la base de datos donde se va a guardar todos los datos que va ofrecer telegraf.</p>

<pre><code>debian@serranito:~$ wget https://dl.influxdata.com/influxdb/releases/influxdb_1.7.9_amd64.deb
debian@serranito:~$ sudo dpkg -i influxdb_1.7.9_amd64.deb
</code></pre>

<p>Una vez ha terminado la instalación, arrancaremos el servicio.</p>

<p><img src="https://i.imgur.com/bEW6Vnc.png" alt="" /></p>

<h2 id="instalación-de-telegraf">Instalación de Telegraf</h2>

<pre><code>debian@serranito:~$ wget https://dl.influxdata.com/telegraf/releases/telegraf_1.13.1-1_amd64.deb
debian@serranito:~$ sudo dpkg -i telegraf_1.13.1-1_amd64.deb
</code></pre>

<p>Reiniciamos los servicios:</p>

<pre><code>root@serranito:~# systemctl restart telegraf
</code></pre>

<p>Si miramos las bases de datos, se ha creado una base de datos para telegraf.</p>

<pre><code>&gt; show databases
name: databases
name
----
_internal
telegraf
&gt; 
</code></pre>

<p>Vamos a ver la configuración que tenemos que hacer en el fichero de configuración telegraf.</p>

<pre><code>debian@serranito:~$ sudo nano /etc/telegraf/telegraf.conf 
</code></pre>

<p>Lo dejaremos por defecto pero cambiaremos lo siguiente:</p>

<pre><code>[agent]
  interval = &quot;10s&quot;
  flush_interval = &quot;10s&quot;
  precision = &quot;s&quot;
  hostname = &quot;serranito&quot;

[[outputs.influxdb]]
  urls = [&quot;http://127.0.0.1:8086&quot;]
  database = &quot;telegraf&quot;
  retention_policy = &quot;default&quot;
  write_consistency = &quot;any&quot;
  timeout = &quot;5s&quot;
</code></pre>

<p>Reiniciamos los servicios:</p>

<pre><code>root@serranito:~# systemctl restart telegraf
</code></pre>

<p>Ya tendremos listo dicho servidor.</p>

<h2 id="instalación-de-grafana">Instalación de grafana:</h2>

<pre><code>debian@serranito:~$ sudo apt-get install -y adduser libfontconfig1
debian@serranito:~$ wget https://dl.grafana.com/oss/release/grafana_6.5.3_amd64.deb
debian@serranito:~$ sudo dpkg -i grafana_6.5.3_amd64.deb
</code></pre>

<p>Iniciamos los servicios:</p>

<pre><code>debian@serranito:~$ sudo systemctl restart grafana-server.service 
</code></pre>

<p>Tenemos que habilitar el puerto 3000 en OpenStack:</p>

<p>Si queremos usar el dominio solamente tendremos que añadirlo en el DNS:</p>

<pre><code>grafana         IN      CNAME   serranito
</code></pre>

<p>Ya pondremos entrar a través del siguiente enlace</p>

<p><a href="grafana.ernesto.gonzalonazareno.org:3000">grafana.ernesto.gonzalonazareno.org:3000</a></p>

<p>Ya podremos entrar desde el navegador a grafana</p>

<p><img src="https://i.imgur.com/4KnpAul.png" alt="" /></p>

<p>Accedemos con el usuario admin/admin y nos pedirá que cambiemos la contraseña.</p>

<p><img src="https://i.imgur.com/INyHHfD.png" alt="" /></p>

<p>A partir de ahora ya podremos configurar y enlazar la base de datos, InfluxDB y telegraf.</p>

<p>Le damos a <em>Add data source</em> y seleccionamos InfluxDB.</p>

<p><img src="https://i.imgur.com/PVs2qcQ.png" alt="" /></p>

<p><img src="https://i.imgur.com/wyvY2Aq.png" alt="" /></p>

<p>Guardamos y hacemos la prueba</p>

<p>Si todo ha salido bien es hora de continuar con la creación del dashboard.</p>

<p>Vamos a configurarlo:</p>

<p><img src="https://i.imgur.com/HWTvwQt.png" alt="" /></p>

<p>En la última parte podremos configurar las alertas al correo</p>

<p><img src="https://i.imgur.com/hfcg9tD.png" alt="" /></p>

<p>Le damos a guardar y ya tendremos el primero Dashboard guardado.</p>

<p><img src="https://i.imgur.com/Y3oBrVb.png" alt="" /></p>

<h2 id="clientes">Clientes</h2>

<p>Vamos a ver la configuración que tenemos que realizar en los demás servidores para tener en la misma base de datos todos los servidores y se pueda ver y comparar las gráficas de una manera mas eficiente.</p>

<h3 id="croqueta">Croqueta:</h3>

<p>Vamos a instalar telegraf y posteriormente vamos al fichero de configuración:</p>

<pre><code>debian@croqueta:~$ sudo nano /etc/telegraf/telegraf.conf
</code></pre>

<p>Vamos a cambiar para que acceda al servidor de la base de datos:</p>

<pre><code>[agent]
  interval = &quot;15s&quot;
  flush_interval = &quot;15s&quot;
  precision = &quot;&quot;
  hostname = &quot;croqueta&quot;

[[outputs.influxdb]]
  urls = [&quot;http://10.0.0.8:8086&quot;]
  database = &quot;telegraf&quot;
  skip_database_creation = true
  username = &quot;admin&quot;
  password = &quot;admin&quot;
</code></pre>

<p>Reiniciamos los servicios:</p>

<pre><code>debian@croqueta:~$ sudo systemctl restart telegraf
</code></pre>

<h3 id="tortilla">Tortilla:</h3>

<p>Igual que antes, tenemos que instalar telegraf y nos vamos al fichero de configuración:</p>

<p>Vamos a cambiar para que acceda al servidor de la base de datos:</p>

<pre><code>ubuntu@tortilla:~$ sudo nano /etc/telegraf/telegraf.conf

[agent]
  interval = &quot;15s&quot;
  flush_interval = &quot;15s&quot;
  precision = &quot;&quot;
  hostname = &quot;tortilla&quot;

[[outputs.influxdb]]
  urls = [&quot;http://10.0.0.8:8086&quot;]
  database = &quot;telegraf&quot;
  skip_database_creation = true
  username = &quot;admin&quot;
  password = &quot;admin&quot;
</code></pre>

<p>Reiniciamos los servicios:</p>

<pre><code>ubuntu@tortilla:~$ sudo systemctl restart telegraf

ubuntu@tortilla:~$ sudo systemctl status telegraf
● telegraf.service - The plugin-driven server agent for reporting metrics into InfluxDB
   Loaded: loaded (/lib/systemd/system/telegraf.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2020-01-28 13:20:20 CET; 2s ago
     Docs: https://github.com/influxdata/telegraf
 Main PID: 5935 (telegraf)
    Tasks: 7 (limit: 547)
   CGroup: /system.slice/telegraf.service
           └─5935 /usr/bin/telegraf -config /etc/telegraf/telegraf.conf -config-directory /etc/telegraf/telegraf.d

Jan 28 13:20:20 tortilla systemd[1]: Started The plugin-driven server agent for reporting metrics into InfluxDB.
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! Starting Telegraf 1.13.1
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! Loaded inputs: system cpu disk diskio kernel mem processes swap
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! Loaded aggregators:
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! Loaded processors:
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! Loaded outputs: influxdb
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! Tags enabled: host=tortilla
Jan 28 13:20:21 tortilla telegraf[5935]: 2020-01-28T12:20:21Z I! [agent] Config: Interval:15s, Quiet:false, Hostname:&quot;tortilla&quot;, Flush Interval:15s
</code></pre>

<h3 id="salmorejo">Salmorejo</h3>

<p>Por último vamos a configurar el servidor con CentOS.</p>

<pre><code>[centos@salmorejo ~]$ sudo nano /etc/telegraf/telegraf.conf 

[agent]
  interval = &quot;15s&quot;
  flush_interval = &quot;15s&quot;
  precision = &quot;&quot;
  hostname = &quot;salmorejo&quot;

[[outputs.influxdb]]
  urls = [&quot;http://10.0.0.8:8086&quot;]
  database = &quot;telegraf&quot;
  skip_database_creation = true
  username = &quot;admin&quot;
  password = &quot;admin&quot;
</code></pre>

<p>Reiniciamos y vemos el estado del servicio:</p>

<pre><code>[centos@salmorejo ~]$ sudo systemctl restart telegraf

[centos@salmorejo ~]$ sudo systemctl status telegraf
● telegraf.service - The plugin-driven server agent for reporting metrics into InfluxDB
   Loaded: loaded (/usr/lib/systemd/system/telegraf.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2020-01-28 13:28:25 CET; 1s ago
     Docs: https://github.com/influxdata/telegraf
 Main PID: 17779 (telegraf)
    Tasks: 9 (limit: 4980)
   Memory: 19.8M
   CGroup: /system.slice/telegraf.service
           └─17779 /usr/bin/telegraf -config /etc/telegraf/telegraf.conf -config-directory /etc/telegraf/telegraf.d

ene 28 13:28:25 salmorejo systemd[1]: Stopped The plugin-driven server agent for reporting metrics into InfluxDB.
ene 28 13:28:25 salmorejo systemd[1]: Started The plugin-driven server agent for reporting metrics into InfluxDB.
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! Starting Telegraf 1.13.2
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! Loaded inputs: cpu disk kernel mem system net diskio processes swap
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! Loaded aggregators:
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! Loaded processors:
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! Loaded outputs: influxdb
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! Tags enabled: host=salmorejo
ene 28 13:28:25 salmorejo telegraf[17779]: 2020-01-28T12:28:25Z I! [agent] Config: Interval:15s, Quiet:false, Hostname:&quot;salmorejo&quot;, Flush Interval:15s
[centos@salmorejo ~]$ 
</code></pre>

<p>Una vez, configurado dichos ficheros podemos ver que grafana ya reconoce el servidores.</p>

<p><img src="https://i.imgur.com/9c1ifGN.png" alt="" /></p>

<h2 id="creación-de-los-dashboard">Creación de los Dashboard</h2>

<p>Vamos a crear un Dashboard nuevo y cambiamos el host para que salgan los diferentes servisores en la misma gráfica.</p>

<p><img src="https://i.imgur.com/hsHtZMR.png" alt="" /></p>

<p>En el último paso podemos definir las alertas:</p>

<p><img src="https://i.imgur.com/IHgzIpA.png" alt="" /></p>

<p>Le damos a guardar y nos saldrá en el panel principal de la siguiente forma:</p>

<p><img src="https://i.imgur.com/krEgZi1.png" alt="" /></p>

<p>Ahora vamos a ir configurando los diferentes <strong>dashboard</strong>.</p>

<p><img src="https://i.imgur.com/5gqApFw.png" alt="" /></p>

<p><img src="https://i.imgur.com/7eQu9Ib.png" alt="" /></p>

<p><img src="https://i.imgur.com/V5hfAj7.png" alt="" /></p>

<h2 id="alertas-por-correo-telegram-etc">Alertas por correo, telegram, etc.</h2>

<p>Vamos a ver una utilidad que nos ofrece grafana, las alertas son muy interesantes y útiles para poder ver errores o una alerta de exceso de recursos de nuestros servidores.</p>

<p>Vamos a ver como se configuran:</p>

<p>Primero vamos a dirigirnos a la siguiente pestaña de grafana:</p>

<p><img src="https://i.imgur.com/QjltVa9.png" alt="" /></p>

<p>Le daremos a <strong>&ldquo;Add channel&rdquo;</strong>:</p>

<p><img src="https://i.imgur.com/UhzsSHD.png" alt="" /></p>

<p>En este panel podremos configurar los tipos de canales para transmitir las alertas, en mi caso voy a configurarlo para <strong>&ldquo;Discord&rdquo;</strong>, una aplicación muy útil (parecida a <em>Slack</em>), donde tendremos un servidor con usuarios y a ese canal de texto se le puede dar privilegios para ciertos usuarios.</p>

<p>Aqui tendremos que poner el nombre de la alerta, el tipo de canal para leer los mensajes de alerta y un <strong><em>Webhook URL</em></strong>, que es una URL que añades al sistema para recibir eventos de email.</p>

<p><img src="https://i.imgur.com/c0jrdZA.png" alt="" /></p>

<p>A continuación, vamos a crear y configurar un servidor de <strong><em>Discord</em></strong>,</p>

<p>Una vez creado entramos en los <strong>ajustes</strong> del <strong>canal de texto</strong> que deseemos para tener ordenado las alertas.</p>

<p>Aquí le pondremos encontrar los <strong><em>Webhook</em></strong> que tenemos y poder crear más. Le pondremos un nombre para reconocerlo y copiamos la URL que nos proporciona para ponerlo en <strong>Grafana</strong>.</p>

<p><img src="https://i.imgur.com/wRYYf0J.png" alt="" /></p>

<p>Como podemos apreciar se ha creado correctamente el <strong><em>Webhook</em></strong>, en nuetro canal de texto de <strong>Discord</strong>.</p>

<p><img src="https://i.imgur.com/4HoMXWR.png" alt="" /></p>

<p>Ahora solamente tendremos que poner la <strong>URL</strong>, en <strong>Grafana</strong>. y realizamos un <strong>test</strong>.</p>

<p><img src="https://i.imgur.com/X9s52GP.png" alt="" /></p>

<p><img src="https://i.imgur.com/iOzk1xd.png" alt="" /></p>

<p>Se ha <strong>realizado correctamente el test</strong> y nos lo muestra en nuestro <strong>servidor de Discord</strong> en el <strong>canal de texto</strong> que le hemos seleccionado.</p>

<p>Por último tendremos que indicarle el <strong>nivel de alertas</strong> en el <strong>Dashboard de Grafana</strong>.
Esta última opción nos permite configurar graficamente los niveles de alertas que vamos a recibir.</p>

<p>En mi caso, voy a poner que me avise si sobrepasa el valor en los diferentes servidores y si ese valor se mantiene durante un minuto me envie la alerta.</p>

<p><img src="https://i.imgur.com/KThJsEr.png" alt="" /></p>

<p>Aquí pondremos a quien se lo queremos enviar y el mensaje que va  recibir. En mi caso pondremos <strong>&ldquo;Discord&rdquo;</strong>, pero si queremos poner un <strong>correo</strong> solamente tendremos que activar <strong>smtp</strong> en <strong>grafana.ini</strong> y colocar la dirección de correo.</p>

<p><img src="https://i.imgur.com/qZEm0Tm.png" alt="" /></p>

<p>Vamos a ver un ejemplo de como envia la alerta:</p>

<p><img src="https://i.imgur.com/yYLPRtb.png" alt="" /></p>

<p>Como podemos apreciar, nos envia correctamente la <strong>alerta</strong>, sale el <strong>nombre</strong> y la <strong>descripción</strong> que hemos configurado previamente junto a una <strong>imagen</strong> donde podemos ver gráficamente el problema.</p>

<p>Aviso del correcto funcionamiento de los servidores:</p>

<p><img src="https://i.imgur.com/eHv9Msg.png" alt="" /></p>

<p><strong>Credenciales</strong>:
*<strong>user*:</strong> admin
*<strong>password*:</strong> evazgar123</p>

    </section>
    <footer class="post-footer">
      
    </footer>
  </article>
</main>

        <footer class="site-footer">
  <section class="rss"><a class="subscribe-button icon-feed" href="/index.xml"></a></section>
  <section class="twitter"><a class="icon-twitter" href="https://twitter.com/ernestovazgar"> ernestovazgar</a></section>
  
  <section class="copyright">&copy; 2020 De Rookie a Leyenda</section>
  <section class="poweredby"><a href="https://github.com/nirocfz/arabica">Arabica</a> theme by Sean Lunsford. Published with <a href="https://gohugo.io">Hugo</a>.</section>
</footer>



    </body>
</html>
