<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    <title>
      
      Proxy, proxy inverso y balanceadores de carga - De Rookie a Leyenda
      
		</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/icons.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    
    <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Lato:100,100i,300,300i,400,400i,700,700i|Source+Code+Pro:300,400,500,700" rel="stylesheet">
    

    
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script type="text/javascript" src="/assets/bigfoot/dist/bigfoot.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/bigfoot/dist/bigfoot-number.css" />
    <script type="text/javascript">
        $.bigfoot();
    </script>
    
    
</head>

    <body class="post-template">
        <header class="main-header">
	<div class="main-header-content">
		<h1 class="blog-title">
			<a href="/">
				
           De Rookie a Leyenda
				
			</a>
		</h1>
		<h2 class="blog-description">Ernesto Vázquez García</h2>
	</div>

	<div class="nav">
    
		
	</div>
</header>

        
<main class="content" role="main">
  <article class="post">
    <header class="post-header">
      
      <h2 class="post-title">Proxy, proxy inverso y balanceadores de carga</h2>
      <section class="post-meta">
        <time class="post-date">February 18, 2020</time>
      </section>
    </header>
    <section class="post-content">
      

<h2 id="balanceador-de-carga">Balanceador de carga</h2>

<p>Primero vamos a instalar <strong>HAproxy</strong></p>

<pre><code>vagrant@balanceador:~$ sudo apt install haproxy
</code></pre>

<p>Vamos al fichero de configuración y pondremos lo siguiente:</p>

<pre><code>vagrant@balanceador:/etc/haproxy$ sudo nano haproxy.cfg 

global
    daemon
    maxconn 256
    user    haproxy
    group   haproxy
    log     127.0.0.1       local0
    log     127.0.0.1       local1  notice
defaults
    mode    http
    log     global
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
listen granja_cda
    bind 192.168.1.80:80
    mode http
    stats enable
    stats auth  cda:cda
    balance roundrobin
    server uno 10.10.10.11:80 maxconn 128 check port 80
    server dos 10.10.10.22:80 maxconn 128 check port 80

root@balanceador:~# systemctl restart haproxy

root@balanceador:~#  systemctl enable haproxy
Synchronizing state of haproxy.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable haproxy
</code></pre>

<p><img src="https://i.imgur.com/wIRP8cm.png" alt="" />
<img src="https://i.imgur.com/HoFJRsd.png" alt="" /></p>

<p>Nos pedirá un usuario y un password, ambos <strong>cda</strong>.</p>

<p><img src="https://i.imgur.com/UQi7ARw.png" alt="" /></p>

<p><img src="https://i.imgur.com/tZWK0SG.png" alt="" /></p>

<p>Vamos a ver el <strong>log de apache1</strong>. Como podemos apreciar figura como única dirección IP, la IP interna de la máquina balanceador ya que dicho balanceador hemos espcificado un balanceo <strong>tipo roundrobin</strong>, este es que se encarga de hacer la peticiones a estos servidores.</p>

<pre><code>root@apache1:~# cat /var/log/apache2/access.log 

10.10.10.1 - - [19/Feb/2020:15:43:13 +0000] &quot;GET / HTTP/1.1&quot; 200 436 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.10.10.1 - - [19/Feb/2020:15:43:14 +0000] &quot;GET / HTTP/1.1&quot; 200 436 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.10.10.1 - - [19/Feb/2020:15:43:14 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 435 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.10.10.1 - - [19/Feb/2020:15:45:25 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 435 &quot;-&quot; &quot;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
</code></pre>

<h3 id="configurar-la-persistencia-de-conexiones-web-sticky-sessions">Configurar la persistencia de conexiones Web (sticky sessions)</h3>

<pre><code>vagrant@balanceador:~$ sudo nano /etc/haproxy/haproxy.cfg 

...
    cookie PHPSESSID prefix                             
    server uno 10.10.10.11:80 cookie EL_UNO maxconn 128 
    server dos 10.10.10.22:80 cookie EL_DOS maxconn 128    
</code></pre>

<p><img src="https://i.imgur.com/VbAymPi.png" alt="" /></p>

<p><img src="https://i.imgur.com/ZeYasXv.png" alt="" /></p>

<p>Cabecera:</p>

<p><img src="https://i.imgur.com/nTa2cWK.png" alt="" /></p>

    </section>
    <footer class="post-footer">
      
    </footer>
  </article>
</main>

        <footer class="site-footer">
  <section class="rss"><a class="subscribe-button icon-feed" href="/index.xml"></a></section>
  <section class="twitter"><a class="icon-twitter" href="https://twitter.com/ernestovazgar"> ernestovazgar</a></section>
  
  <section class="copyright">&copy; 2020 De Rookie a Leyenda</section>
  <section class="poweredby"><a href="https://github.com/nirocfz/arabica">Arabica</a> theme by Sean Lunsford. Published with <a href="https://gohugo.io">Hugo</a>.</section>
</footer>



    </body>
</html>
